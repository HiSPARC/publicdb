---
- name: upgrade all packages
  yum: name=* state=latest
  sudo: yes

- name: ensure /usr/local/bin is in sudoers
  lineinfile: dest=/etc/sudoers regexp='secure_path'
              line="Defaults    secure_path = /opt/miniconda/bin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin"
              state=present
  sudo: yes

- name: add HTTP access to firewall rules
  lineinfile: dest=/etc/sysconfig/system-config-firewall
              regexp='--service=http' line='--service=http'
              state=present
  sudo: yes

- name: Compile firewall rules
  command: lokkit --update
  sudo: yes

- name: Restart firewall (IPv4)
  service: name=iptables state=restarted enabled=yes
  sudo: yes

- name: Restart firewall (IPv6)
  service: name=ip6tables state=restarted enabled=yes
  sudo: yes

# Bootstrapping EPEL repository trick
# http://zigg.com/2013/yum-repository-bootstrapping-ansible.html
- name: bootstrap epel-release install
  copy: src=ansible-bootstrap-epel.repo
        dest=/etc/yum.repos.d/
        owner=root group=root mode=0644
  sudo: yes

- name: epel-release install
  yum: name=epel-release
       enablerepo=ansible-bootstrap-epel
       state=present
  sudo: yes

- name: epel repository enable
  ini_file: dest=/etc/yum.repos.d/epel.repo
            section=epel
            option=enabled
            value=1
  sudo: yes

- name: upgrade all packages (including EPEL)
  yum: name=* state=latest
  sudo: yes

- name: install ACL utilities
  yum: name=acl
  sudo: yes

- name: ensure /usr/local/lib is in ld.so.conf
  lineinfile: dest=/etc/ld.so.conf
              regexp='/usr/local/lib'
              line='/usr/local/lib' state=present
  sudo: yes

- name: ensure local source directory exists
  file: path=/usr/local/src/hisparc state=directory
        owner=hisparc group=hisparc mode=2775
  sudo: yes

- name: set default group write ACLs on /usr/local/src
  command: /usr/bin/setfacl -m d:g::rwx /usr/local/src/hisparc
  sudo: yes

- name: install screen
  yum: name=screen
  sudo: yes

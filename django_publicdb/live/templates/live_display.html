{% extends 'base_live.html' %}

{% load url from future %}

{% block title %}{{ block.super }}{% endblock %}

{% block head %}
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/flot_live.js"></script>
    <script type="text/javascript">
        function downloadGraph(target) {
            var dataurl = $(target + ' .flot-base')[0].toDataURL();
            window.open(dataurl, '_blank', "height=350, width=630, toolbar=yes")
        }

        $(document).ready(function() {
            var data = [];
            var iterator = 1;
            var baseurl = "{% url 'live.views.get_new_event' station.number %}"

            function fetchData() {
                function onDataReceived(traces) {
                    if (iterator < 40) {
                        ++iterator}
                    else {
                        iterator = 1}
                    data = [];
                    for (var i = 0; i < traces.data.length; i++) {
                        data.push({data: traces.data[i], yaxis: 1});}
                    $.plot("#tr_graph", data, tr_options);}

                $.ajax({url: baseurl + iterator,
                        type: "GET",
                        dataType: "json",
                        success: onDataReceived});
                setTimeout(fetchData, 5000);
            }
            setTimeout(fetchData, 5000);
        });

    </script>
{% endblock %}

{% block data %}
    <div id="graphs">

      {% if traces %}
        <div id="traceGraph" class="graph">
            <h3>Signal</h3>
            <div class="sourceLink">
                <a onclick="downloadGraph('#tr_graph')">Image</a>
            </div>
            <div class="plot" id="tr_graph"></div>
            <script type="text/javascript">
                $.plot($("#tr_graph"), [
                  {% for data in traces.data %}
                    {data: {{ data }}, yaxis: 1},
                  {% endfor %}
                    {data: [0, 0], lines: {show: false}, xaxis: 2, yaxis: 2}],
                    tr_options);
            </script>
        </div>
      {% endif %}
    </div>
{% endblock %}

{% extends 'base_live.html' %}

{% load url from future %}

{% block title %}{{ block.super }}{% endblock %}

{% block head %}
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/flot_live.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/screenfull.min.js"></script>
    <script type="text/javascript">

        function downloadGraph(target) {
            var dataurl = $(target + ' .flot-base')[0].toDataURL();
            window.open(dataurl, '_blank', "height=350, width=630, toolbar=yes")
        }

        function resizeToFit() {
            w_scale = $(window).width() / 1920;
            h_scale = $(window).height() / 1080;
            scale = Math.min(w_scale, h_scale);
            $('body').css({'zoom': scale,
                         '-moz-transform': 'scale(' + scale + ')',
                         '-moz-transform-origin': '0 0'})
        }

        $(document).ready(function() {
            // Automatically resize the content to fit in window
            resizeToFit();
            $(window).resize(function() {
                resizeToFit();
            });

            // Show a fullscreen button if browser support Fullscreen API
            if (screenfull.enabled) {
                $('#fullscreen').css('visibility', 'visible').click(function() {
                    screenfull.toggle();
                });}

            // Set constants
            var refreshRate = 5000;
            var iteratorStart = 40;
            var iterator = iteratorStart;
            var baseurl = "{% url 'live.views.get_new_event' station.number %}"
            var tr_graph = $("#tr_graph");

            function fetchData() {
                function onDataReceived(event) {
                    if (iterator > 1) {
                        iterator--;}
                    else {
                        iterator = iteratorStart;}
                    var data = [];
                    for (var i = 0; i < event.traces.data.length; i++) {
                        data.push({data: event.traces.data[i], yaxis: 1});}
                    data.push({data: [1, 1], lines: {show: false}, xaxis: 2, yaxis: 2});
                    var plot = $.plot(tr_graph, data, tr_options);
                     // add labels
                    h = plot.getPlotOffset();
                    o = plot.pointOffset({ x: 0, y: -53});
                    tr_graph.append('<div style="position:absolute;right:' + (h.right + 4) + 'px;top:' + o.top + 'px;color:#666;font-size:smaller">low</div>');
                    o = plot.pointOffset({ x: 0, y: -123});
                    tr_graph.append('<div style="position:absolute;right:' + (h.right + 4) + 'px;top:' + o.top + 'px;color:#666;font-size:smaller">high</div>');
                    o = plot.pointOffset({ x: 0, y: -210});
                    tr_graph.append('<div style="position:absolute;right:' + (h.right + 4) + 'px;top:' + o.top + 'px;color:#666;font-size:smaller">MIP</div>');
                    $('#n_events').html(event.count)
                    $('#nth_event').html(event.count - iterator)
                    $('#timestamp').html(event.event.timestamp + '.' + event.event.nanoseconds)
                    $('#date').html(new Date(event.event.timestamp * 1000).toUTCString())
                }
    
                $.ajax({url: baseurl + iterator + '/',
                        type: "GET",
                        dataType: "json",
                        success: onDataReceived});
                setTimeout(fetchData, refreshRate);
            }

            // Show first trace and initiate auto refresh
            fetchData();

            var fromProjection = new OpenLayers.Projection("EPSG:4326"); // transform from WGS 1984
            var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
            var options = {
                controls: [
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.ScaleLine()]};
            var map = new OpenLayers.Map("map", options);
            var mapLayer = new OpenLayers.Layer.OSM();
            map.addLayer(mapLayer);
            map.setCenter(new OpenLayers.LonLat({{ config.gps_longitude }}, {{ config.gps_latitude }})
                                        .transform(fromProjection, toProjection), 16);

            var stationLayer = new OpenLayers.Layer.Vector("station");
            var feature = new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.Point({{ config.gps_longitude }}, {{ config.gps_latitude }}).transform(fromProjection, toProjection), {},
                    {pointRadius: 6,
                     fillColor: '#2A7AE2',
                     fillOpacity: 1,
                     stroke: true,
                     strokeWidth: 0.5});
            stationLayer.addFeatures(feature);
            map.addLayer(stationLayer);

            var bounds = stationLayer.getDataExtent();
            map.zoomToExtent(bounds);
        });

    </script>
{% endblock %}

{% block content %}
    <div id="fullscreen">
        <a>Toggle fullscreen</a>
    </div>

    {{ block.super }}

    <div id="traces">
        <div id="traceGraph" class="graph">
            <h3>Event signal</h3>
            <div class="plot" id="tr_graph"></div>
        </div>
    </div>

    <div id="data">
        <h3>Event data</h3>
        <div class="sectionTitle">Time</div>
        <div class="keyvalue"><span class="key">Event</span><span class="value" id="nth_event"></span> (<span class="value" id="n_events"></span>)</div>
        <div class="keyvalue"><span class="key">Timestamp</span><span class="value" id="timestamp"></span> s</div>
        <div class="keyvalue"><span class="key">Date</span><span class="value" id="date"></span></div>
        <div class="keyvalue"><span class="key">Density</span><span class="value" id="density">mips</span></div>
    </div>

    <div id="reconstruction">
        <h3>Reconstruction</h3>
        <div class="sectionTitle">Origin and energy</div>
        <div class="keyvalue"><span class="key">Primary energy</span><span class="value">reconstruction.energy</span></div>
        <div class="keyvalue"><span class="key">Core distance</span><span class="value">reconstruction.distance</span></div>
        <div class="keyvalue"><span class="key">Zenith angle</span><span class="value">reconstruction.zenith</span></div>
        <div class="keyvalue"><span class="key">Azimuth angle</span><span class="value">reconstruction.azimuth</span></div>
    </div>

    <div class="clearer"></div>

    <div id="info">
        <h3>Station Info</h3>
        <div class="sectionTitle">Station info</div>
        <div class="keyvalue"><span class="key">PMT channels</span><span class="value ch1">ch1</span> <span class="value ch2">ch2</span>{% if config.slave != 'no slave' %} <span class="value ch3">ch3</span> <span class="value ch4">ch4</span>{% endif %}</div>
        <div class="keyvalue"><span class="key">Trigger conditions</span><span class="value">{{ config.trig_low_signals }} low {% if config.trig_and_or %}or{% else %}and{% endif %} {{ config.trig_high_signals }} high</span></div>
        <div class="sectionTitle">GPS location</div>
        <div class="keyvalue"><span class="key">Longitude</span><span class="value">{{ config.gps_longitude }} &deg;</span></div>
        <div class="keyvalue"><span class="key">Latitude</span><span class="value">{{ config.gps_latitude }} &deg;</span></div>
        <div class="keyvalue"><span class="key">Altitude</span><span class="value">{{ config.gps_altitude }} m</span></div>
        <div class="sectionTitle">Layout</div>
        <div class="keyvalue"><span class="key">Shape</span><span class="value">triangle</span></div>
    </div>

    <div id="location">
        <h3>Location</h3>
        <div id="map"></div>
    </div>
    
{% endblock %}

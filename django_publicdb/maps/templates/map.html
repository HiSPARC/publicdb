{% load url from future %}
{% load fix_strings %}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>
    <link rel="icon" type="image/vnd.microsoft.icon" href="{{ STATIC_URL }}favicon.ico" />
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>HiSPARC Station map</title>
    <link rel="stylesheet" type="text/css" media="all" href="{{ STATIC_URL }}styles/base.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{ STATIC_URL }}styles/OpenLayers-2.12.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{ STATIC_URL }}styles/map_controls.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{ STATIC_URL }}styles/maps.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/jquery.flot-0.8a.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/jquery.flot.axislabels.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/jquery.flot.time.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/OpenLayers-2.13b.min.js"></script>
    <!--[if lte IE 8]><script type="text/javascript" src="{{ STATIC_URL }}scripts/excanvas.min.js"></script><![endif]-->
    <script type="text/javascript">
        $(document).ready(function() {
            var fromProjection = new OpenLayers.Projection("EPSG:4326"); // transform from WGS 1984
            var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
            var options = {
                fractionalZoom: true,
                controls: [
                    new OpenLayers.Control.Navigation(
                        {dragPanOptions: {enableKinetic: true}}),
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.ScaleLine()]};
            var map = new OpenLayers.Map("map", options);
            var mapLayer = new OpenLayers.Layer.OSM(null, null,
                {serverResolutions: [156543.03390625, 78271.516953125,
                                     39135.7584765625, 19567.87923828125,
                                     9783.939619140625, 4891.9698095703125,
                                     2445.9849047851562, 1222.9924523925781,
                                     611.4962261962891, 305.74811309814453,
                                     152.87405654907226, 76.43702827453613,
                                     38.218514137268066, 19.109257068634033,
                                     9.554628534317017, 4.777314267158508,
                                     2.388657133579254, 1.194328566789627,
                                     0.5971642833948135],
                 transitionEffect: 'resize'});
            map.addLayer(mapLayer);
            var colors = {"down": 'red',
                          "problem": 'gold',
                          "up": 'green',
                          "unknown": 'blue'};
            var context = {
                getColor: function(feature) {
                    return colors[feature.attributes["status"]];},
                getLabel: function(feature) {
                    if (map.getZoom() >= 14) {
                        return feature.attributes["id"];}
                    else {
                        return ''}},
                getSize: function(feature) {
                    return .5 * map.getZoom();}};
            var pointStyle = {
                fillColor: "${getColor}", // using context.getColor(feature)
                fillOpacity: 0.8,
                strokeColor: 'black',
                strokeOpacity: 0.75,
                strokeWidth: 1,
                pointRadius: "${getSize}", // using context.getSize(feature)
                cursor: 'pointer',
                label: '${getLabel}', // using context.getLabel(feature)
                labelYOffset: 16,
                fontSize: 12,
                fontFamily: 'sans-serif',
                fontWeight: 'bold'};
            var style = new OpenLayers.Style(pointStyle, {context: context});

            map.setCenter(new OpenLayers.LonLat(4.950, 52.355).transform(fromProjection, toProjection), 5);
            {% for subcluster in subclusters %}
                var {{ subcluster.name|slugify|remove_hyphens }} = new OpenLayers.Layer.Vector("{{ subcluster.name }}", {styleMap: new OpenLayers.StyleMap(style)});
                    {% for station in subcluster.stations %}
                        {% if station.longitude and station.latitude %} 
                            var feature = new OpenLayers.Feature.Vector(
                                new OpenLayers.Geometry.Point({{ station.longitude }}, {{ station.latitude }})
                                                       .transform(fromProjection, toProjection),
                                {id: {{ station.number }},
                                 name: "{{ station.name }}",
                                 subcluster: "{{ station.cluster }}",
                                 cluster: "{{ station.cluster.parent }}",
                                 status: "{{ station.status }}"});
                            {{ subcluster.name|slugify|remove_hyphens }}.addFeatures(feature);
                        {% endif %}
                    {% endfor %}
                map.addLayer({{ subcluster.name|slugify|remove_hyphens }});
            {% endfor %}
            // Zoom to fit cluster
            {% if focus %}
                {% for layer in focus %}
                    {% if forloop.first %}
                        var bounds = {{ layer|slugify|remove_hyphens }}.getDataExtent();
                    {% else %}
                        bounds.extend({{ layer|slugify|remove_hyphens }}.getDataExtent());
                    {% endif %}
                {% endfor %}
                if (bounds) {
                    map.zoomToExtent(bounds);
                    map.zoomTo(Math.floor(map.getZoom()));}
            {% endif %}
        });
    </script>
</head>

<body>
<div id="map"></div>
</body>

</html>
